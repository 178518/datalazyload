/*! datalazyload - v1.0 - 2013-05-09 2:47:09 PM
* Copyright (c) 2013 kissy-team; Licensed  */
KISSY.add("gallery/datalazyload/1.0/index",function(t,e,a,r,n){function o(t,a){t.style.display=A,t.className="";var r=e.create("<div>");t.parentNode.insertBefore(r,t),e.html(r,t.value,a)}function i(e,a){var r,n;return(r=e.id)||(r=e.id=t.guid("ks-lazyload")),(n=a.ksLazyloadId)||(n=a.ksLazyloadId=t.guid("ks-lazyload")),r+n}function s(t){return t._ks_lazy_width?t._ks_lazy_width:t._ks_lazy_width=e.outerWidth(t)}function c(t){return t._ks_lazy_height?t._ks_lazy_height:t._ks_lazy_height=e.outerHeight(t)}function l(t,a,r){if(!t.offsetWidth)return!1;var n,o=e.offset(t),i=!0,l=o.left,u=o.top,f={left:l,top:u,right:l+s(t),bottom:u+c(t)};return n=d(a,f),n&&r&&(i=d(r,f)),i&&n}function u(e,a){var r=this;if(!(r instanceof u))return new u(e,a);var n=e;t.isPlainObject(n)||(n=a||{},e&&(n.container=e)),u.superclass.constructor.call(r,n),r._callbacks={},r._containerIsNotDocument=9!=r.get("container").nodeType,r._initLoadEvent()}function d(t,e){var a={};return a.top=Math.max(t.top,e.top),a.bottom=Math.min(t.bottom,e.bottom),a.left=Math.max(t.left,e.left),a.right=Math.min(t.right,e.right),a.bottom>=a.top&&a.right>=a.left}function f(a,r,n,i){function s(){"img-src"===r&&(r="img"),t.isArray(a)||(a=[e.get(a)]);var s=n||h+p,c=n||v+p;t.each(a,function(t){var a=e.nodeName(t);"img"==r?"img"==a?w(t,s,i):e.query("img",t).each(function(t){w(t,s,i)}):"textarea"==a?e.hasClass(t,c)&&o(t,!0):e.query("textarea."+c,t).each(function(t){o(t,!0)})})}i?g(s):s()}function g(t){if(z.detected)t(z.supported);else{var r,n="data:image/webp;base64,UklGRjgAAABXRUJQVlA4ICwAAAAQAgCdASoEAAQAAAcIhYWIhYSIgIIADA1gAAUAAAEAAAEAAP7%2F2fIAAAAA";r=e.create("<img>"),a.on(r,"load error",function(e){var a=e.type+"";"load"==a?z.supported=4===Number(this.width):"error"==a&&(z.supported=!1),z.detected=!0,t(z.supported)}),e.attr(r,"src",n)}}var m=t.Env.host,_=m.document,h="data-ks-lazyload",v="ks-datalazyload",p="-custom",y="default",A="none",b="scroll",k="touchmove",I="resize",x=100,z={detected:!1,supported:!1},w=function(e,a,r){a=a||h;var n=e.getAttribute(a),o="";if(n&&e.src!=n){if(r&&z.supported){if(t.isFunction(r))o=r(n,e);else if(t.isArray(r)){var i,s,c=r.length;for(i=0;c>i;i++)if(s=r[i],n.match(s[0])){o=n.replace(s[0],s[1]);break}}}else o=n;o||(o=n),e.src=o,e.removeAttribute(a)}};return u.ATTRS={diff:{value:y},placeholder:{value:"http://a.tbcdn.cn/kissy/1.0.0/build/imglazyload/spaceball.gif"},execScript:{value:!0},container:{setter:function(a){return a=a||_,t.isWindow(a)?a=a.document:(a=e.get(a),"body"==e.nodeName(a)&&(a=a.ownerDocument)),a},valueFn:function(){return _}},autoDestroy:{value:!0},webpFilter:{value:null}},t.extend(u,r,{_filterItems:function(){var a=this,r=a.userConfig,n=a.get("container"),o=[],i=[],s=[n];t.isArray(r.container)&&(a._backCompact=1,s=r.container),t.each(s,function(r){o=o.concat(t.filter(e.query("img",r),a._filterImg,a)),i=i.concat(e.query("textarea."+v,r))}),a._images=o,a._textareas=i},_filterImg:function(t){var e=this,a=e.get("placeholder");return t.getAttribute(h)?(t.src||(t.src=a),!0):n},_initLoadEvent:function(){function e(){a._filterItems(),a._isLoadAllLazyElements()||t.ready(s),a.resume()}var a=this,r=new Image,n=a.get("placeholder"),o=a.get("autoDestroy"),i=function(){a._loadItems(),o&&a._isLoadAllLazyElements()&&a.destroy()},s=function(){a.get("webpFilter")?g(function(){i()}):i()};a._loadFn=t.buffer(s,x,a),r.src=n,r.complete?e():r.onload=e},refresh:function(){this._loadFn()},_loadItems:function(){var t,e,a=this,r=a.get("container");(!a._containerIsNotDocument||r.offsetWidth)&&(e=a._getBoundingRect(),!a._backCompact&&a._containerIsNotDocument&&(t=a._getBoundingRect(a.get("container"))),a._loadImgs(e,t),a._loadTextAreas(e,t),a._fireCallbacks(e,t))},_loadImgs:function(e,a){var r=this;r._images=t.filter(r._images,function(t){return l(t,e,a)?w(t,n,r.get("webpFilter")):!0},r)},_loadTextAreas:function(e,a){var r=this,n=r.get("execScript");r._textareas=t.filter(r._textareas,function(t){return l(t,e,a)?o(t,n):!0},r)},_fireCallbacks:function(e,a){var r=this,n=r._callbacks;t.each(n,function(t,r){var o=t.el,i=!1,s=t.fn;l(o,e,a)&&(i=s.call(o)),i!==!1&&delete n[r]})},addCallback:function(t,a){var r=this,n=r._callbacks;t=e.get(t),n[i(t,a)]={el:e.get(t),fn:a},r._loadFn()},removeCallback:function(t,a){var r=this._callbacks;t=e.get(t),delete r[i(t,a)]},getElements:function(){return{images:this._images,textareas:this._textareas}},addElements:function(a){"string"==typeof a?a=e.query(a):t.isArray(a)||(a=[a]);var r=this,n=r._images||[],o=r._textareas||[];t.each(a,function(e){var a=e.nodeName.toLowerCase();"img"==a?t.inArray(e,n)||n.push(e):"textarea"==a&&(t.inArray(e,o)||o.push(e))}),r._images=n,r._textareas=o},removeElements:function(a){"string"==typeof a?a=e.query(a):t.isArray(a)||(a=[a]);var r=this,n=[],o=[];t.each(r._images,function(e){t.inArray(e,a)||n.push(e)}),t.each(r._textareas,function(e){t.inArray(e,a)||o.push(e)}),r._images=n,r._textareas=o},_getBoundingRect:function(a){var r,o,i,s;if(a!==n){r=e.outerHeight(a),o=e.outerWidth(a);var c=e.offset(a);i=c.left,s=c.top}else r=e.viewportHeight(),o=e.viewportWidth(),i=e.scrollLeft(),s=e.scrollTop();var l=this.get("diff"),u=l===y?o:l,d=0,f=u,g=l===y?r:l,m=0,_=g,h=i+o,v=s+r;return t.isObject(l)&&(d=l.left||0,f=l.right||0,m=l.top||0,_=l.bottom||0),i-=d,h+=f,s-=m,v+=_,{left:i,top:s,right:h,bottom:v}},_isLoadAllLazyElements:function(){var e=this;return 0==e._images.length+e._textareas.length+(t.isEmptyObject(e._callbacks)?0:1)},pause:function(){var t=this,e=t._loadFn;if(!t._destroyed&&(a.remove(m,b,e),a.remove(m,k,e),a.remove(m,I,e),e.stop(),t._containerIsNotDocument)){var r=t.get("container");a.remove(r,b,e),a.remove(r,k,e)}},resume:function(){var t=this,e=t._loadFn;if(!t._destroyed&&(a.on(m,b,e),a.on(m,k,e),a.on(m,I,e),t._containerIsNotDocument)){var r=t.get("container");a.on(r,b,e),a.on(r,k,e)}},destroy:function(){var e=this;e.pause(),e._callbacks={},e._images=[],e._textareas=[],t.log("datalazyload is destroyed!"),e.fire("destroy"),e._destroyed=1}}),u.loadCustomLazyData=f,u.checkWebpSupport=g,t.DataLazyload=u,u},{requires:["dom","event","base"]});